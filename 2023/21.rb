input = <<~INPUT
...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
...........
INPUT

input = <<~INPUT
...................................................................................................................................
..#......##................#......#.#............#.....#....#.................#.......#.....#.#.....##.....#.#........#.#..#....#..
.......#....###...###.........##...#.#..#.....#......#...#................................................#.........##.#.#..#..###.
....#.....#..#.#.....#....#.#.##.#..........#...#.......................#...##......#...#.#.#....###.....#....#......#....#...#.#..
..##.#......##...##......#...#.#.#..##.#......#.........#............................#.........#...................#....#........#.
.#..........#....#.....#.....#..#.....#........#...........................#..#.#........#....#.#.....#.#...#..................#...
.#.#.#.#.#............#.....#.....#....#...........#.........................................#...#.......#....#....#.......#..#..#.
.#......##.#.#..............#....#.....####....#..#.............................#............#..............###.#.....#............
..#........#.........#....#................##..................#..#........................#.#.#.......###..#...#...#..............
.......#........#.......##.#..#.............................#.........................#........#........#.#.#..##..#..#.#......#...
.....#.#.#.##....................#.#.#....##.#....#...............#..###.......#.............#......#....#...#..#...............#..
.#..#...#.........#............#..#......#.#.....#...........#....#.....#..........#...........##......##.....#.#........#.........
........#.....#..#......#....#.#........##.#...........................#.......................##.....##..#........#.#......#.#....
..........#..#...............#..#..........#...#..........#.....#..#...#...........#..................#...................###..#.#.
.#..#......#..#...#.#..#.....#.....###.........#...........#.#............#........#.....###.......##.....#.#.#...........#........
.#.....#....##..##..#...........#.....#.......#.........#...#..............##..........#...#..#..#...#............#.#.#.......#....
.#..#.#.#.......#....................#................#.#................#..............#..#..##..#.#..#..###....#.....#..#........
...#.....#.......##..#............##.....#..#..........#......##.......#..............#.#..#.......#.........#.....................
..#.#.....#.......#....#.........##................##....#...#.......................................#.......#.#..##......#...#....
...........#.#.#.....#...#.#..#....#..#..............#.#.#....#....##...................#....#......#........#....#..##...#...#....
....#........#....#.#..##...##...................#.....#........#....#...#.#.#.#.............#.....#.#.......##..#.#.......#....#..
.##.#....#.......#.#......##.....#.#.#............#.......#........#...........................#.......##...#...##....#.........#..
.......#....#................#..##.............###.....#.............#....#......##........#.##...................#................
....#.......##.................#...................##..#..............#.......##..##...........#..##...#.#.....#...###.....#.......
.#.............................##................#......#...#...........#.#.#......#...........##.....##................#.#........
.#.##.#........##.........#.....##.#...........#...........#.#....##.....##.......#...........#..#.......#.##......#.....#...#...#.
...#...##.......#.#...#.......#...#.................#......#..#...............#.#.#........................#...........#.....#.....
.......#.#...#..##.........#.....#........#..##.#.#....#........#..##..........#...#..#..............#......##..#....#.......#.....
...##.......#..#......#...........................#..#.........#.............##........#.........#...#................#..###.......
.........................##................#.#...##....#......#.#..#....#....#....#..#..........................#.#..#.......#.....
....#.....#...#.........#..#............##...#..#........#........##.#..#...........#..........................#...#.....#......#..
.......................#..............#..#...#...............#..#.#..#..#...#...#.#..........................#.......#..#..........
....##.#.............#...#.................##....#......#....#.##........#...............##............##.#.................#...#..
...#...#..#...........#........................#....#.#.......#..........#.......##.......................##..#.#....#...........#.
..............#......##............#...##.#..........#....#....#.......#...................##..............#...#........#..#..#....
.......#............##..#.#........#....#.##....#.....#.#.#.....#......#....#..........#...#...#..................#....##..........
.............#....#...#..#..............#.......#........##...#...#..#....#...........##....#............#....#...#.#.#........#...
.#.....###.#.....................#..........#.#.....#..#...#.#.#.....................#.............................................
.#...#...........#.....#...........#....#....##.........#..#......#..#....#.....#....#.#...#..................##.........#..#....#.
.#.......#......................##.........................#....#...#......##......#........#......#.........#.......##.#...#......
....##...........#...#.......#.......##........#................#.......#.#.##.............#..#.#................##.....#..#...##..
..........#.#.................#..#..#...##.###.......##.#..#........##......##..##...#...#..#..#####.#.........#..#...#.#..........
..#....#..#.#...............#...............#.#..####......#..........##.#...##...#.#................#................#.##..##..#..
..........#....##..........#..............#.......#.......#.#...#..##.....................#.#.#....#...#...........#...............
...#.......#.................#...........#..#........#...#..............#..............#....#...##....................#...#........
...####...#.............##.....#............#.##.....#...#..#.#......#.............#.........##....##...................#.#...#....
....#.....#.............#.....##...#..#...........#..#.....#......#.#.....#......#.....#....#......#...............................
.....#...#..##.............#....##...#.......#...##......##.....#.......#...#........................#.#.......................#.#.
.###.....#...#................#....#.....................###.#....#..#.#....................#....................................#.
...#..................#..#..#........##....#..#.#.##..#.#...#.........#..#.#...#...............#...........##..........##.#........
...........#..................#.............#...#.#.#......###..........#...#.......#.......#....#........#.#...........##.........
.......#..#.......##..#............................##.....#.#..#.......##.....#...#.......#...........#....#...#...................
...#.............#.................#.#.###......##.........####.....#..##.............#.......##.....#....................#........
.#................#.#..#..#..#..##.....#.......#..#.....#.......#....#.......#.............#.##......#.#.....#..............#..#...
.....#.................#...#....#.#...#.#......#.#...........#............#...#..........................###...#.................#.
...........................#..#.#..#...#...............#...#...#....#...........##...........#...#..#.#........#..###........#.....
..................##....##......##.#........#..#...........#......#..............#........#...#..............#...#.#..........##...
...#...............#...###..#...........#.....#.......##.#...#..........##.....#........#.#.#..................##..#............#..
..#........#......#.....#.........#.......##......#..........#...........#..#.##....#...................#.##.......##..........##..
...............#...##....###.........#...#..............#.#.......#...#.....#.........##..#.......##..............#................
............#........#......##.#................##...#.....##...#.....##.......#..................#........#.##.#.....#.##.........
..........#....#....#...##..#.#..........#.............##..#......#.#......#.#..............#........#...#..#............##........
...........#.......##...#......#..#......#.#.......#.........#...........#.....#..##...#...##..............##........#.#..#........
............#....#.......#..........#..##..#...##...#.#.#.....#............#.#.......#.#..#........##......#....#.#.....#..........
.......................#...........##.#..........#.....#.#.#..........#.#.............................#....##.....##......#..#.....
.................................................................S.................................................................
.....#.##.#..........#..#..#........#.#...#......#......#....#.#.....#.#..............................#.............#.....#........
......#.....#....#..#........#.....#.........#........#..#...#.......#.#.....##.....##....#..#.#..#.#..........#....#...#..........
...................##....#........#.#.........#.......#........................#.....#.#...#..###.......###..#...#.....##..........
.........#.#...#.#.#.#......#............#....#.#........................#.......#.#.#........#..............#..#.#...#............
...............#..#.#...#..#......#....#....#.......##...............#.#.#..#......#...##.........................#................
.#.....................#..#..#..............#....#...#...#....##....#.#...#.......##.#...........###...#.......#####...............
..#........#............#.#...#.......#...#...........#......#....#...........#..#..............#....#..#...##.......#..........##.
.#.#.....................#..............#.#.........#.#...............#......#......#.#..##...#......#......#........##............
..............#....#.#....##.##.....#........#...............#..........................#...#....#.##.........#....................
..................##...............##..#....##..............#.....#...#........#.#...#...............###....#................#.###.
.#...#............#.#.#..##....#......#........#.#........#.....#......#.......##.....#.#.#.....................#..................
...#.#.............#.............#.#.##...#.#.............................................#....##..#.#.....#..................#....
......#............#...#.......#.#..#......#.......#.....#.#.......#...##....##....##.............####...................#..#......
.........#........#.....#..#...........#.#.......##.#..#....#..#.....#.#..#.#....#......#...................#.............#....#.#.
......#................#..................#............#.............#.....#.........#...##.....#.#.##..#..###.........##.......#..
.............................#....#.....#.#............##....#..#......#..#.#....#.................#....#...#.........#............
....#.#.....................#........#.........##..............#...#..............................#....#.................#.......#.
.#..#.................#..........#..#....#........##..#...............#......####.....#....#.....#..#....###........#.#.........#..
....##........#.........#...#..##.#.##....#......##........#......###..........#.#...#....#..#......................#........##....
........#.....#.#.........#......#.#........#....#..##....##................##.......#...#........#...........................#....
.#...........#............#..........#.......#.##.......#.#........#...#..###...#..#......#.............#................##....##..
..................#..........##...##....##.#.....#.....####........##........#...#.........#...#.....#..#...........##......#..#.#.
...............#.....................#................#...#....#......................#.#.......#...............#.....#......#...#.
...#............#.............#.##...................#....#...#.....#...#...........#.#...#........#................##.....#.......
...........#........#..................#.#..#.#.....#...............#.....#.#........##.......#..#.#..........#.............#......
..#.....#....#.#.................#.#.........#.......##.....#.........#.....#...............#.#...##.......................#....#..
......###....#....#.#..#....................#....#....#..#........#...#.#...##........#..##........#............#.........#....#.#.
...#.#.....#....#......#.........#..##...#.##...#....#..##..#.#........#..##.#.................#...................................
.........###.#...#...#...........................#.........#.#.##....#.#...#..........#..#.......#.........##.....#......#...#.#...
.................#.....#..........#.#..#..###..................#........##....#.........#...................#....#.........#.....#.
.#..#....#..#...#.....#............#.#..........#....#.#..#..##......................#..#..#......................#.............#..
..#..#.#...#..#.....#...............................#.........##......#.............#.##...............#..#.##.......##..#.......#.
.....#...#.#....#...#..#..............#......#.#................#....#..#...........#.....#.#................#.##.........##.......
....#......##.........#.#...#.........#......#.##...##........#....#.................#......................###......#.....##......
...#.#.....#.....#.#.#.#...............#..#.....#.#...............#.#.........##.....##..#...................#.......#.#...........
..#.....#..#.....#...##....##..##.........#...#....#....#...#......##.##..#..#.........#............#..#.##...................#....
...#....###...#..........##......#........#..........#.............###.....#.....#..#.#...............#...##....#...##..#..#...#.#.
...#................#.........#................#..#..#..#.#...............#.....#...................#.................#...#........
.#.......#.#.#.#.......#...................#...#......##.....#........##.....#...#........................#..#..#....#......#..#...
..##..#....#...#.......#........#...#....................###........##............#...............#....#.......#............#......
.#............#.....#...##....#.......................#..#....#........#..........#..#...........#..#........................#.....
..........###....#..#.#..#..#.........#.......#...#......#....#...#.............#............#.....................#.#...#.......#.
...#..#..............................#.........#........##....##....##..##.....##......................#........#.....#...#...#.#..
.#.#.................##.......#.#.#.....................#.....#........#......##.............#.......#..##....##........#.#.#......
...##.#.#..#...#........#......#.....#....................#........#.#.....#...#................#........#...#.##.....#..#.......#.
.##.#.......#..#....#..#....#......#.....................#...........#......#.#..............#...#......#.#.......#......#.#.......
....#................###...#.......#...#..##........#...................#.......................#..##.......#................###...
.........##.....#.....##..........#....#..##.............#.....##......##....#..................#..##.................#...#........
.#..#....#....#.#........#..#................#............#.......#........#...................................##........#.......#.
.........##...#........#.#............#.......#..........#.................#..........................#......##.....#....#.#....##.
...##......................#.....#....#.##...................#.............#..............#....#......#.............#........#.....
....#...........##.......#...#.....#.......#..#................#........##......................#..#....#..##.....#.#..............
......#..#...#......#.......#.....#.#..........#................#................#.....#.#.#....#...#..............................
....#....#..#...##..##.......#...................##..............................#........#................#....#..........#..#.#..
....#...##.....##...#......#.............#.......#..............................#..........#...............................#.#.....
.##.#.....#..#.......#..##................#..#..##..#..........#..............#..#.#....#.#..#..##.#....#.##..#............#.....#.
....#..#.#............##.....##.............###.#............#.#.....#....................#.#........#....#.#..#..#...........#.#..
.#.......#..................#...................#....#..........#...........#....#......#.........#.............##...............#.
..#...............##..#.#...###.....#...#....#....#...#........#..#....................##.#.......#...#.......#................#...
..#.##..........##......#...#.#.#.#.....##.....#.##..#..#.........#........#....................#.................#............##..
....#...##.......##....##...#.#..............#.....#......................#.#......#...................#..#.#...##.#..........#..#.
.#.#....#..##..#..............###.......................###................#..#..#..##....#....#............##..#..................
......#..#......#.........#.#.#...#.......................##..............##...#.....##.#....#......#....#.........#.......#.....#.
....#.........#...............#...#............#.........#................##.#..........#.............#.......................#.##.
...................................................................................................................................
INPUT

require "rb_heap"

grid = input.split("\n").map(&:chars)
startx, starty = nil, nil
grid.each_with_index do |row, y|
  row.each_with_index do |cell, x|
    if cell == "S"
      startx, starty = x, y
      break
    end
  end
end

queue = Heap.new { |a, b| a[0] < b[0] }
queue << [0, startx, starty]
distance = {}
distance[[startx, starty]] = 0

until queue.empty?
  u = queue.pop
  d, x, y = u

  [[0, 1], [0, -1], [1, 0], [-1, 0]].each do |dx, dy|
    new_x = x + dx
    new_y = y + dy

    next unless new_x >= 0 && new_y >= 0 && new_y < grid.size && new_x < grid[new_y].size
    next if grid[new_y][new_x] == "#"
    new_d = d + 1

    if new_d < distance.fetch([new_x, new_y], Float::INFINITY)
      distance[[new_x, new_y]] = new_d
      queue << [new_d, new_x, new_y]
    end
  end
end

puts "Part 1: #{distance.values.count { |d| d <= 64 && d % 2 == 0 }}"

##########
# PART 2 #
##########

steps = 0
cycle = []
seen = Set.new
even = Set.new
odd = Set.new
n = 26501365

queue = Heap.new { |a, b| a[0] < b[0] }
queue << [0, startx, starty]

until queue.empty?
  new_steps, x, y = queue.pop

  next if seen.include?([x, y])
  seen << [x, y]

  if new_steps != steps && steps % (grid.size * 2) == n % (grid.size * 2)
    cycle << (steps % 2 == 0 ? even.size : odd.size)

    if cycle.size == 3
      c = cycle[0]
      b = cycle[1] - cycle[0]
      a = cycle[2] - 2 * cycle[1] + cycle[0]
      x = n / (grid.size * 2)
      result = a * (x * (x - 1) / 2) + b * x + c

      puts "Part 2: #{result}"
      exit
    end
  end

  steps, next_steps = new_steps, new_steps + 1
  [[0, 1], [0, -1], [1, 0], [-1, 0]].each do |dx, dy|
    if grid[(y + dy) % grid.size][(x + dx) % grid.size] != "#"
      if next_steps % 2 == 0
        even << [x + dx, y + dy]
      else
        odd << [x + dx, y + dy]
      end

      queue << [next_steps, x + dx, y + dy]
    end
  end
end
