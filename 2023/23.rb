input = <<~INPUT
#.#####################
#.......#########...###
#######.#########.#.###
###.....#.>.>.###.#.###
###v#####.#v#.###.#.###
###.>...#.#.#.....#...#
###v###.#.#.#########.#
###...#.#.#.......#...#
#####.#.#.#######.#.###
#.....#.#.#.......#...#
#.#####.#.#.#########v#
#.#...#...#...###...>.#
#.#.#v#######v###.###v#
#...#.>.#...>.>.#.###.#
#####v#.#.###v#.#.###.#
#.....#...#...#.#.#...#
#.#########.###.#.#.###
#...###...#...#...#.###
###.###.#.###v#####v###
#...#...#.#.>.>.#.>.###
#.###.###.#.###.#.#v###
#.....###...###...#...#
#####################.#
INPUT

input = <<~INPUT
#.###########################################################################################################################################
#.#.....###.......#...#.....#.......#.........###...#...###...#.........#.....#...#.......#.........#...#...###.......#...#.................#
#.#.###.###.#####.#.#.#.###.#.#####.#.#######.###.#.#.#.###.#.#.#######.#.###.#.#.#.#####.#.#######.#.#.#.#.###.#####.#.#.#.###############.#
#...#...#...#.....#.#.#.#...#...#...#...#.....#...#.#.#...#.#.#...#...#.#.#...#.#.#...#...#.....#...#.#.#.#...#.....#.#.#.#...#.......#.....#
#####.###.###.#####.#.#.#.#####.#.#####.#.#####.###.#.###.#.#.###.#.#.#.#.#.###.#.###.#.#######.#.###.#.#.###.#####.#.#.#.###.#.#####.#.#####
#.....###...#...#...#.#.#.#####.#.###...#...###...#.#...#.#.#...#...#.#.#.#.#...#.#...#...###...#.###.#.#.#...###...#.#.#.#...#.....#.#.....#
#.#########.###.#.###.#.#.#####.#.###.#####.#####.#.###.#.#.###.#####.#.#.#.#.###.#.#####.###.###.###.#.#.#.#####.###.#.#.#.#######.#.#####.#
#.........#.#...#...#.#.#.#.>.>.#.###.#.....#...#.#.#...#...#...###...#...#.#...#.#.....#...#...#.#...#...#...#...###...#...#.......#.......#
#########.#.#.#####.#.#.#.#.#v###.###.#.#####.#.#.#.#.#######.#####.#######.###.#.#####.###.###.#.#.#########.#.#############.###############
#.........#.#...#...#...#.#.#.###...#.#.#...#.#.#.#.#.....#...#...#.......#.#...#.#...#...#...#.#.#.#.......#.#.#.......#...#.........#.....#
#.#########.###.#.#######.#.#.#####.#.#.#.#.#.#.#.#.#####.#.###.#.#######.#.#.###.#.#.###.###.#.#.#.#.#####.#.#.#.#####.#.#.#########.#.###.#
#.#...#...#.###.#.......#.#.#.#.....#.#.#.#.#.#.#.#.#...#.#.###.#.#...#...#.#.#...#.#.###.#...#.#.#...#.....#...#.....#...#...........#...#.#
#.#.#.#.#.#.###v#######.#.#.#.#.#####.#.#.#.#.#.#.#.#.#.#.#.###.#.#.#.#.###.#.#.###.#.###.#.###.#.#####.#############.###################.#.#
#.#.#.#.#...###.>.......#...#.#...#...#.#.#.#.#.#.#.#.#...#.>.>.#...#.#.#...#.#.#...#...#.#...#.#.>.>.#.#.......#.....#.....#...#.....###.#.#
#.#.#.#.#######v#############.###.#.###.#.#.#.#.#.#.#.#######v#######.#.#.###.#.#.#####.#.###.#.###v#.#.#.#####.#.#####.###.#.#.#.###.###.#.#
#.#.#.#.#...#...#...#.........###.#.###.#.#.#.#.#.#...#.......#.....#.#.#.>.>.#.#.#...#.#.###.#.###.#...#...#...#.....#.#...#.#.#.#...#...#.#
#.#.#.#.#.#.#.###.#.#.###########.#.###.#.#.#.#.#.#####.#######.###.#.#.###v###.#.#.#.#.#.###.#.###.#######.#.#######.#.#.###.#.#.#.###.###.#
#.#.#.#.#.#.#.....#.#...........#.#...#...#.#.#.#.....#.......#.#...#.#.###...#...#.#.#.#...#.#...#.#...#...#.....###...#.....#...#.....#...#
#.#.#.#.#.#.#######.###########.#.###.#####.#.#.#####.#######.#.#.###.#.#####.#####.#.#.###.#.###.#.#.#.#.#######.#######################.###
#.#.#.#.#.#...###...#...........#.....#.....#.#...#...#...###...#...#...#####...###.#.#.#...#.#...#.#.#...###...#.#...#...#...#.....#.....###
#.#.#.#.#.###.###.###.#################.#####.###.#.###.#.#########.###########.###.#.#.#.###.#.###.#.#######.#.#.#.#.#.#.#.#.#.###.#.#######
#...#.#.#...#.....###.................#.....#...#.#.#...#...#...###.........###...#.#.#.#.#...#...#.#.#.....#.#...#.#...#...#.#...#.#.......#
#####.#.###.#########################.#####.###.#.#.#.#####.#.#.###########.#####.#.#.#.#.#.#####.#.#.#.###.#.#####.#########.###.#.#######.#
#.....#.###...#...###.................#...#.#...#...#.....#.#.#.###...#...#.#.....#.#.#...#.....#.#...#...#.#...###.........#.#...#.......#.#
#.#####.#####.#.#.###.#################.#.#.#.###########.#.#.#.###.#.#.#.#.#.#####.#.#########.#.#######.#.###.###########.#.#.#########.#.#
#.#.....#...#...#...#.........#...#...#.#.#...#...........#...#.....#...#...#.......#...###...#...###.....#.....#...........#...#.....#...#.#
#.#.#####.#.#######.#########.#.#.#.#.#.#.#####.#######################################.###.#.#######.###########.###############.###.#.###.#
#...#...#.#.........#...#####...#...#...#...###.......#.....#...#...###...#...#.........#...#...#...#.........###.................#...#...#.#
#####.#.#.###########.#.###################.#########.#.###.#.#.#.#.###.#.#.#.#.#########.#####.#.#.#########.#####################.#####.#.#
#.....#...#...#...#...#...#...........#.....#...#...#...###...#...#...#.#.#.#.#...#...###.#.....#.#.....#####.....#...........#...#.#####...#
#.#########.#.#.#.#.#####.#.#########.#.#####.#.#.#.#################.#.#.#.#.###v#.#.###.#.#####.#####.#########.#.#########.#.#.#.#########
#.#...#.....#.#.#.#...#...#.........#...#...#.#...#.#...#...###.......#.#...#...>.>.#.#...#.....#.....#.#.........#.........#...#.#...#.....#
#.#.#.#.#####.#.#v###.#.###########.#####.#.#.#####.#.#.#.#.###.#######.#########v###.#.#######.#####.#.#.#################.#####.###.#.###.#
#...#...###...#.#.>.#.#...#.......#.#...#.#.#.....#...#.#.#.#...#...###.....#.....###...#.......#...#.#.#.........#...#...#.....#.....#.#...#
###########.###.#v#.#.###.#.#####.#.#.#.#.#.#####.#####.#.#.#.###.#.#######.#.###########.#######.#.#.#.#########.#.#.#.#.#####.#######.#.###
###...#...#.....#.#.#.#...#...###...#.#.#.#.#...#.....#.#.#.#.#...#.#.......#.....#.....#...#.....#.#.#.#.........#.#.#.#.#.....###...#.#.###
###.#.#.#.#######.#.#.#.#####v#######.#.#.#.#.#.#####.#.#.#.#.#.###.#.###########.#.###.###.#.#####.#.#.#.#########.#.#.#.#v#######.#.#.#.###
#...#...#.........#.#.#.....>.>.#...#.#.#.#.#.#.#...#.#.#.#.#...###.#.........#...#.#...#...#.....#.#.#.#.....#...#.#.#.#.>.#...#...#...#...#
#.#################.#.#######v#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.#######v#########.#.###.#.###.#######.#.#.#.#####v#.#.#.#.#.###v#.#.#.#########.#
#...#.............#.#.....#...#...#.#.#.#.#.#.#.#.#.#.#.#.#.#.....>.>.#.....#.#...#.#...#.......#.#...#.....>.>.#.#.#.#.#...#.#.#...#.......#
###.#.###########.#.#####.#.#######.#.#.#.#.#.#.#.#.#.#.#.#.#.#####v#.#.###.#.###.#.###.#######.#.###########v###.#.#.#.#.###.#.###.#.#######
#...#.#.....#.....#...#...#.......#.#.#...#.#.#.#.#...#.#.#...#...#.#.#.###...###.#.###.......#.#.#.........#...#.#.#.#.#...#.#.....#.....###
#.###.#.###.#.#######.#.#########.#.#.#####.#.#.#.#####.#.#####.#.#.#.#.#########.#.#########.#.#.#.#######.###.#.#.#.#.###.#.###########.###
#...#.#...#.#.......#.#.#.........#.#...#...#.#.#.....#...#...#.#...#...#...#####...#.....#...#...#.......#.#...#.#.#...#...#.#.....#...#...#
###.#.###.#.#######.#.#.#.#########.###.#.###.#.#####.#####.#.#.#########.#.#########.###.#.#############.#.#.###.#.#####.###.#.###.#.#.###.#
#...#.#...#.#.......#...#.........#...#.#.#...#...#...#.....#.#.......#...#...###...#...#.#.....#...#.....#.#.###...#...#.....#...#...#.....#
#.###.#.###.#.###################.###.#.#.#.#####.#.###.#####.#######.#.#####.###.#.###.#.#####.#.#.#.#####.#.#######.#.#########.###########
#.....#...#.#...#...###...........###.#.#...#...#...###.....#...#.....#.....#.....#.....#...#...#.#.#.....#.#.......#.#...........#...#...###
#########.#.###.#.#.###.#############.#.#####.#.###########.###.#.#########.###############.#.###.#.#####.#.#######.#.#############.#.#.#.###
#...#.....#.....#.#...#...#.........#...#...#.#...#...#...#.###...#.....#...#.....#.....###...#...#.......#.........#.#...#.......#.#.#.#...#
#.#.#.###########.###.###.#.#######.#####.#.#.###.#.#.#.#.#.#######.###.#.###.###.#.###.#######.#####################.#.#.#.#####.#.#.#.###.#
#.#...#.....#...#.#...###...#...#...#...#.#.#.#...#.#.#.#.#.......#.#...#.#...###...###...#.....#.........#...#...#...#.#.#...#...#.#.#.#...#
#.#####.###.#.#.#.#.#########.#.#.###.#.#.#.#.#.###.#.#.#.#######.#.#.###.#.#############.#.#####.#######.#.#.#.#.#.###.#.###.#.###.#.#.#.###
#.......###...#...#...#.......#...###.#.#.#...#...#.#.#.#.#.......#.#...#.#...#...........#.....#.#.....#.#.#.#.#.#.....#.....#...#.#...#...#
#####################.#.#############.#.#.#######.#.#.#.#.#v#######.###.#.###.#.###############.#.#.###.#.#.#.#.#.###############.#.#######.#
#...........###.......#...........#...#.#.......#.#.#...#.>.>.#.....#...#.....#...............#.#.#...#...#.#.#.#.#...#...#.......#.#.......#
#.#########.###.#################.#.###.#######.#.#.#######v#.#.#####.#######################.#.#.###.#####.#.#.#.#.#.#.#.#.#######.#.#######
#.#...#...#...#.......#...#.......#...#.......#.#.#.#.....#.#.#...#...###...###...#...#.......#...###...#...#...#.#.#.#.#.#.......#.#.......#
#.#.#.#.#.###.#######.#.#.#.#########.#######.#.#.#.#.###.#.#.###.#.#####.#.###.#.#.#.#v###############.#.#######.#.#.#.#.#######.#.#######.#
#...#...#...#.........#.#.#...###...#.......#.#.#.#.#...#.#.#...#.#...#...#.#...#.#.#.>.>.#...#...###...#...#.....#.#.#.#.#.....#...###.....#
###########.###########.#.###.###.#.#######.#.#.#.#.###.#.#.###.#.###.#.###.#.###.#.###v#.#.#.#.#.###.#####.#.#####.#.#.#.#.###.#######.#####
#.........#.....#.....#.#.#...#...#.#...#...#...#...#...#...###...#...#...#.#.#...#.#...#.#.#.#.#...#.#.....#.......#.#.#.#.#...###...#.....#
#.#######.#####.#.###.#.#.#.###.###.#.#.#.###########.#############.#####.#.#.#.###.#.###.#.#.#.###.#.#.#############.#.#.#.#.#####.#.#####.#
#.......#.......#.#...#.#.#...#...#.#.#...#####...###.............#.....#.#.#.#.#...#.###.#.#.#.#...#.#...#...........#.#...#.#...#.#.#.....#
#######.#########.#v###.#.###v###.#.#.#########.#.###############.#####.#.#.#.#.#.###.###.#.#.#.#.###v###.#.###########.#####.#.#.#.#.#.#####
#.......#.......#.#.>.#.#...>.>.#.#.#.###.......#.......#.........#.....#.#.#.#...###...#.#.#...#...>.>.#.#.###...#...#...#...#.#.#.#.#...###
#.#######.#####.#.#v#.#.#####v#.#.#.#.###.#############.#.#########.#####.#.#.#########.#.#.#########v#.#.#.###.#.#.#.###.#.###.#.#.#.###v###
#.....#...#...#...#.#.#...#...#...#.#...#.#...#...#...#...#.......#...#...#...#...#...#.#.#.#.........#...#...#.#.#.#.#...#.#...#.#.#.#.>.###
#####.#.###.#.#####.#.###.#.#######.###.#.#.#.#.#.#.#.#####.#####.###.#.#######.#.#.#.#.#.#.#.###############.#.#.#.#.#.###.#.###.#.#.#.#v###
#...#...###.#.......#.....#.......#.....#...#...#...#.......#...#.###...###.....#...#...#...#.#...#...###.....#.#.#.#...###...#...#.#...#...#
#.#.#######.#####################.###########################.#.#.#########.#################.#.#.#.#.###.#####.#.#.###########.###.#######.#
#.#.###...#...............#...#...#.........#.................#...#...#...#.................#.#.#...#...#.......#...#...#.....#.....#.....#.#
#.#.###.#.###############.#.#.#.###.#######.#.#####################.#.#.#.#################.#.#.#######.#############.#.#.###.#######.###.#.#
#.#.#...#...#...#.........#.#.#.###.#.......#...............#.......#.#.#.........#.........#...#...###.....#.....###.#.#.#...#...#...#...#.#
#.#.#.#####.#.#.#v#########.#.#v###.#.#####################.#.#######.#.#########.#.#############.#.#######.#.###.###.#.#.#.###.#.#v###.###.#
#.#.#.#...#...#.#.>...#...#.#.>.>...#.###...#.....#.........#.....#...#.........#...#.........#...#.........#...#...#.#...#.#...#.>.###...#.#
#.#.#.#.#.#####.#v###.#.#.#.###v#####.###.#.#.###.#.#############.#.###########.#####.#######.#.###############.###.#.#####.#.#####v#####.#.#
#.#.#...#...#...#...#.#.#.#.###.....#...#.#.#.#...#.....#...###...#.#...#.....#.....#.#.......#.#.........#####...#.#...###...#...#...#...#.#
#.#.#######.#.#####.#.#.#.#.#######.###.#.#.#.#.#######.#.#.###.###.#.#.#.###.#####.#.#.#######.#.#######.#######.#.###.#######.#.###.#.###.#
#.#.#...#...#.......#...#...#.......###.#.#.#.#...#.....#.#...#.#...#.#.#.#...#...#.#.#.......#.#...#.....#.....#.#.#...#.......#...#.#...#.#
#.#.#.#.#.###################.#########.#.#.#.###.#.#####.###.#.#.###.#.#.#.###.#.#v#.#######.#.###.#.#####.###.#.#.#.###.#########.#.###.#.#
#.#...#.#...#.....#...#...#...#...#...#...#.#.#...#.....#.#...#.#.###.#.#.#.#...#.>.>.#.......#.....#.....#...#...#.#.#...#.......#...#...#.#
#.#####.###.#.###.#.#.#.#.#.###.#.#.#.#####.#.#.#######.#.#.###.#.###.#.#.#.#.#####v###.#################.###.#####.#.#.###.#####.#####.###.#
#.#...#.###...###...#...#.#.....#...#...#...#.#.#...#...#.#.....#...#.#.#.#.#.#####.#...###.....#...#####...#.....#.#.#.#...#.....#...#...#.#
#.#.#.#.#################.#############.#.###.#.#.#.#.###.#########.#.#.#.#.#.#####.#.#####.###.#.#.#######.#####.#.#.#.#.###.#####.#.###.#.#
#...#.#...................#.............#...#.#...#.#.###.###...#...#.#.#.#.#.#.....#.....#.#...#.#.###...#.###...#...#.#.#...#...#.#.###...#
#####.#####################.###############.#.#####.#.###.###.#.#.###.#.#.#.#.#.#########.#.#.###.#.###.#.#v###.#######.#.#.###.#.#.#.#######
#...#.............#...#...#.........#...###...###...#.#...#...#...#...#...#...#.......#...#.#...#.#.....#.>.>.#.......#...#.....#...#.......#
#.#.#############.#.#.#.#.#########.#.#.#########.###v#.###.#######.#################.#.###.###.#.#########v#.#######.#####################.#
#.#.....#...#...#...#...#...###.....#.#.......#...#.>.>.###...#...#.....#.............#...#.#...#...#.......#...#...#...#...................#
#.#####.#.#.#.#.###########.###.#####.#######.#.###.#v#######.#.#.#####.#.###############.#.#.#####.#.#########.#.#.###.#.###################
#.#...#...#...#.....#.....#...#.#.....#.......#.....#...#...#...#.#...#.#.......#...#...#.#.#.#...#.#.#...#...#...#.#...#.........#.........#
#.#.#.#############.#.###.###.#.#.#####.###############.#.#.#####.#.#.#.#######.#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.#####.#.###########.#.#######.#
#.#.#.....#.......#...###.#...#...#...#...........#...#...#.....#...#...###.....#.#...#.#.#.#.#.#.#.#.#.#...#.....#.#...#.......#...#.......#
#.#.#####.#.#####.#######.#.#######.#.###########.#.#.#########.###########.#####.#####.#.#.#.#.#.#.#.#.#########.#.###.#.#####.#####.#######
#.#.#.....#.#.....###...#...#...#...#.............#.#...........###...#...#.......#.....#.#.#.#.#...#...#.....#...#.....#.....#.....#.....###
#.#.#.#####.#.#######.#.#####.#.#.#################.###############.#.#.#.#########.#####.#.#.#.#########.###.#.#############.#####.#####.###
#...#.......#.........#.....#.#.#...#...#.........#.#.........#...#.#.#.#.#...#...#.#...#...#.#...#.......###...#.......#####.....#.#...#...#
###########################.#.#.###.#.#.#.#######.#.#.#######.#.#.#.#.#.#.#.#.#.#.#.#.#.#####.###.#.#############.#####.#########.#.#.#.###.#
###...................#.....#.#...#...#...#...#...#...#.......#.#.#.#.#.#.#.#.#.#.#.#.#.#...#.....#...........###.....#...#.......#...#.....#
###.#################.#.#####.###.#########.#.#.#######.#######.#.#.#.#.#.#.#.#.#.#.#.#.#.#.#################.#######.###.#.#################
#...#.....#.........#.#.#...#.#...#...#.....#...###.....#.....#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.#...#####...#...#.....###...#.#...#.............#
#.###.###.#.#######.#.#.#.#.#.#.###.#.#.###########.#####.###.#.#.#.#.#.#.#.#.#.#.#v#.#.#.#.#.#.#####.#.#.#.#####.#####.#.###.#.###########.#
#.....###...###.....#...#.#.#.#...#.#.#...........#.......#...#.#.#.#.#.#.#.#.#.#.>.>.#...#...#...#...#...#.......#.....#...#...#...........#
###############.#########.#.#.###.#.#.###########.#########.###.#.#.#.#.#.#.#.#.###v#############.#.###############.#######.#####.###########
#...............#.....###.#.#...#...#.#...........#...#.....#...#.#.#...#.#.#.#.###.....#.........#...#.......#...#...#...#.......#...###...#
#.###############.###.###.#.###.#####.#.###########.#.#.#####.###.#.#####.#.#.#.#######.#.###########.#.#####.#.#.###.#.#.#########.#.###.#.#
#.#.............#...#...#.#.#...#.....#.......#...#.#.#.#...#...#.#.#.....#.#.#.....#...#.........###...#.....#.#.#...#.#.#...#...#.#.....#.#
#.#.###########v###.###.#.#.#.###.###########.#.#.#.#.#v#.#.###.#.#.#.#####.#.#####.#.###########.#######.#####.#.#.###.#.#.#.#.#.#.#######.#
#.#.#.........#.>.#.#...#.#.#...#.#.......#...#.#.#.#.>.>.#...#.#.#.#.....#.#.......#...#.........#...#...#...#.#.#.....#...#...#...#.......#
#.#.#.#######.#v#.#.#.###.#.###.#.#.#####.#.###.#.#.###v#####.#.#.#.#####.#.###########.#.#########.#.#.###.#.#.#.###################.#######
#.#.#.......#...#...#...#.#.###.#.#.#.....#.###.#...#...#...#...#...#.....#.###...#...#.#...###...#.#.#...#.#.#.#.#...#...###...#...#.......#
#.#.#######.###########.#.#.###.#.#.#.#####v###.#####.###.#.#########.#####.###.#.#.#.#.###.###.#.#.#.###v#.#.#.#.#.#.#.#.###v#.#.#.#######.#
#...###...#.#.........#.#.#.#...#.#.#.#...>.>.#.#...#.....#.......###.......#...#...#...###.....#.#.#.#.>.>.#.#.#.#.#.#.#...>.#.#.#.#...#...#
#######.#.#.#.#######.#.#.#.#.###.#.#.#.###v#.#.#.#.#############.###########.###################.#.#.#.#v###.#.#.#.#.#.#####v#.#.#.#.#.#.###
#.......#.#...#...#...#.#.#.#.###...#...#...#.#.#.#...............#...#...###.......#.........#...#.#...#...#.#.#.#.#.#...#...#...#...#...###
#.#######.#####.#.#.###.#.#.#.###########.###.#.#.#################.#.#.#.#########.#.#######.#.###.#######.#.#.#.#.#.###.#.#################
#.......#.......#...###...#.#.#...........###...#.................#.#.#.#.#...#...#.#.#.......#...#.....#...#...#...#...#.#.......#.....#...#
#######.###################.#.#.#################################.#.#.#.#.#.#.#.#.#.#.#.#########.#####.#.#############.#.#######.#.###.#.#.#
#...###.....#...........###...#.........#...#.....#...............#.#.#.#...#...#.#...#.........#.......#.............#...#...#...#.#...#.#.#
#.#.#######.#.#########.###############.#.#.#.###.#.###############.#.#.#########.#############.#####################.#####.#.#.###.#.###.#.#
#.#.......#.#.#.........#...#...#.....#...#...#...#.........#.......#.#...#.......###...........###.....#.............###...#.#.....#.....#.#
#.#######.#.#.#.#########.#.#.#.#.###.#########.###########.#.#######.###.#.#########.#############.###.#.###############.###.#############.#
#.......#...#.#.....###...#...#.#...#.#.........#...........#.......#.###.#.#...#...#...###...#...#.#...#...........#...#...#.#.............#
#######.#####.#####.###.#######.###.#.#v#########.#################.#.###.#.#.#.#.#.###v###.#.#.#.#.#.#############.#.#.###.#.#.#############
#.......#.....#...#...#.#.....#.....#.>.>...#...#.......#...#...#...#.#...#.#.#.#.#.#.>.>.#.#.#.#.#.#...#...#.......#.#.#...#.#.....#...#...#
#.#######.#####.#.###.#.#.###.#############.#.#.#######.#.#.#.#.#.###.#.###.#.#.#.#.#.###.#.#.#.#.#.###.#.#.#.#######.#.#.###.#####.#.#.#.#.#
#.#...#...#.....#.....#...###...........###.#.#.###...#.#.#.#.#.#.#...#.#...#.#.#.#.#...#.#.#.#.#.#.#...#.#.#...#...#.#.#...#...#...#.#.#.#.#
#.#.#.#.###.###########################.###.#.#.###.#.#v#.#.#.#.#.#.###.#.###.#.#.#.###.#.#.#.#.#.#.#.###.#.###v#.#.#.#.###.###.#.###.#.#.#.#
#.#.#.#.#...#...#.....###...#...#...#...#...#.#...#.#.>.>.#.#.#.#.#.#...#...#.#...#.#...#.#.#...#.#.#.#...#.#.>.>.#.#.#.###.#...#.....#.#.#.#
#.#.#.#.#.###.#.#.###.###.#.#.#.#.#.#.###.###.###.#.#######.#.#.#.#.#.#####.#.#####.#.###.#.#####.#.#.#.###.#.#####.#.#.###.#.#########v#.#.#
#.#.#...#.....#...#...#...#.#.#.#.#...###...#.###.#.#####...#.#...#.#...#...#...#...#...#.#.###...#.#.#.#...#...###.#.#.#...#...#...#.>.#.#.#
#.#.###############.###.###.#.#.#.#########.#.###.#.#####.###.#####.###.#.#####.#.#####.#.#.###.###.#.#.#.#####.###.#.#.#.#####.#.#.#.#v#.#.#
#.#.#...............#...#...#.#.#.....#.....#.#...#.....#...#...###...#.#.#...#.#...#...#...#...#...#...#...#...#...#.#.#.....#...#...#...#.#
#.#.#.###############.###.###.#.#####.#.#####.#.#######.###.###.#####.#.#.#.#.#.###.#.#######.###.#########.#.###.###.#.#####.#############.#
#...#.......#...#...#.###.#...#.#.....#.#...#.#...#.....###.#...#.....#.#.#.#...#...#.....#...#...#.........#...#...#.#.#...#.....#.........#
###########.#.#.#.#.#.###.#.###.#.#####.#.#.#.###.#.#######.#.###.#####.#.#.#####.#######.#.###.###.###########.###.#.#.#.#.#####.#.#########
#...........#.#.#.#.#...#.#.###.#...#...#.#.#.#...#.......#.#.#...#...#.#.#.#.....#...#...#...#...#.#.....#.....#...#.#.#.#.#...#.#...#.....#
#.###########.#.#.#.###.#.#.###.###.#.###.#.#.#.#########.#.#.#.###.#.#.#.#.#.#####.#.#.#####.###.#.#.###.#.#####.###.#.#.#.#.#.#.###.#.###.#
#.............#...#.....#...###.....#.....#...#...........#...#.....#...#...#.......#...#####.....#...###...#####.....#...#...#...###...###.#
###########################################################################################################################################.#
INPUT

$grid = input.split("\n").map(&:chars)

def neighbours(current)
  cx, cy = current

  neighbours = case $grid[cy][cx]
  when "."
    [
      [cx - 1, cy],
      [cx + 1, cy],
      [cx, cy - 1],
      [cx, cy + 1]
    ]
  when ">"
    [[cx + 1, cy]]
  when "<"
    [[cx - 1, cy]]
  when "^"
    [[cx, cy - 1]]
  when "v"
    [[cx, cy + 1]]
  end

  neighbours.select { |x, y| x >= 0 && y >= 0 && y <= $grid.size - 1 && x <= $grid[y].size - 1 && $grid[y][x] != "#" }
end

def dfs(current, path = [], seen = Set.new)
  if current == [$grid[0].size - 2, $grid.size - 1]
    $longest = [path.size, $longest].max
  end

  neighbours(current).each do |neighbour|
    next if seen.include?(neighbour)

    path << neighbour
    seen << neighbour

    dfs(neighbour, path, seen)

    seen.delete(neighbour)
    path.pop
  end
end

$longest = 0
dfs([1, 0])
puts "Part 1: #{$longest}"

##############
### PART 2 ###
##############

def neighbours2(current)
  cx, cy = current

  neighbours = case $grid[cy][cx]
  when ".", ">", "<", "^", "v"
    [
      [cx - 1, cy],
      [cx + 1, cy],
      [cx, cy - 1],
      [cx, cy + 1]
    ]
  end

  neighbours.select { |x, y| x >= 0 && y >= 0 && y <= $grid.size - 1 && x <= $grid[y].size - 1 && $grid[y][x] != "#" }
end

intersections = Set.new
$distances = Hash.new { |h, k| h[k] = [] }
0.upto($grid.size - 1) do |y|
  0.upto($grid[y].size - 1) do |x|
    if $grid[y][x] != "#" && neighbours2([x, y]).size > 2
      intersections << [x, y]
    end
  end
end

intersections << [1, 0]
intersections << [$grid[0].size - 2, $grid.size - 1]

intersections.each do |x, y|
  queue = [[x, y]]
  seen = Set.new([x, y])
  dist = 0

  until queue.empty?
    next_queue = []
    dist += 1
    queue.each do |current|
      neighbours2(current).each do |neighbor|
        next if seen.include?(neighbor)
        seen << neighbor

        if intersections.include?(neighbor)
          $distances[[x, y]] << [dist, neighbor]
        else
          next_queue << neighbor
        end
      end
    end

    queue = next_queue
  end
end

$longest = 0

def dfs2(current, pathset = Set.new, totaldist = 0)
  if current == [$grid[0].size - 2, $grid.size - 1]
    $longest = [$longest, totaldist].max
  end

  $distances[current].each do |dist, neighbour|
    next if pathset.include?(neighbour)
    pathset << neighbour
    dfs2(neighbour, pathset, totaldist + dist)
    pathset.delete(neighbour)
  end
end
dfs2([1, 0])
puts "Part 2: #{$longest - 2}"
