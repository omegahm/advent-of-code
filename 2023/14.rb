input = <<~INPUT.strip
O....#....
O.OO#....#
.....##...
OO.#O....O
.O.....O#.
O.#..O.#.#
..O..#O..O
.......O..
#....###..
#OO..#....
INPUT

input = <<~INPUT.strip
####....#..O#O..#.....OO.O#..O.......O.#OO.#...O.O..O..O..OO.##.O#...........#....##O#..O#.O.O......
....#..#.........O.O#..OO#OO....O.....#O.#.O##..#...OO#OOO.O...#...O..#.O.#....##.....#O............
...#O..#........#....O...O.......O#.##.O.......O..O#O#.#OO....O..O.......#O.........#O.#.O...#...#..
#O...O...O.O..O..OO.#...O.O#....##O.##..#.OOO#...OO.#...OOO.#.O.#....#....O..##.....OO....#..O...#O.
.#.......##.#...#...O............O...#......#..#.OO...O#....O.#..........O..O.OOO#.#O#....OO..#.#O.#
..#..........#..O.O#.....O.OOO.#.##...##...OO..#..#.O#..OO.O#..#O..#O.O#.O.O#..#.#OOO..#OO.O.##..#..
#..#....O.#O.O.#...O......O...###O.#...OOO#..#.O..#O.O..O.#OO...O...#..#OOO.....O...O...OO..##....O.
...##....#..#.O#..#O...#.#......##.OO.O.......O....#O#..OOOO#....O.#OO.#O....#...O#O#..O.#.....O....
...#O....#.#O........O.O#O....O...#.O....#....#...#O.....O.O.O.#.#.......#.........#O#........O.....
...O...#.O#....#O#O.....O..O#...#O........O.#.##.....O.#...O..#...##O.#.#O#..O..##......#O.#...O#..#
#..OO#.#.........O#......#O.##.O#...O..#.#.#.OO........#......#....#..#.......O.#O.##.###.####....O.
O..O...#O..O..##.O..............#O......OOO#...#.#.#.........OO....OO....O#.#.O#.O.........#.......O
..O#.#....O..#....#OO..##...#..#...O..##O...##.O..O.OO.#.###...O..#.OO..O#...#......#.....O.#..O..#.
O..####.O..O.OO##.O...O..O#.#O..O...O..........#O.#..#..O..O#..O##O.O.#O.#..O.OO.O..#...O.#O..O.O.#.
.......O..........#...OO.O#.#.#OOOO...OO#O..O.#.#......#O.#.#...#.O#......O.O.OO...#.##..#.O.#..O..#
.#.....#O........#.O...#........O............#O......##.O..O..#.#......O#O..O...O..O.#.O...O.#..OOOO
.......O#...O...OO#.....#..O.#O..##..#O.#....OO.##.#O#......O#..O....OO..#...#O...O...##O..O###..OOO
...O...#..O..O..#O.O......#.O...#..O#..#..O.OO...O....O.#O#..###O....O..##OOO.#O.....#...#.....#...O
O...OO.#...#...O.O..#O.OO..O.#.#.#O#.O.#.O..O#O.....##O..O#.O..O........O...#.......O#.#...#.#..OO..
..OO..#.#.O#.OOO.....##.O..OOO##O#.O..O.##OOO...O..##.O......#O.##..#O..O....#.##.O###...##..O......
.......O..OO....##......O..O#O.O.O#....#O.....#....O..O.OO...#.O.#..#....#.O..#O....O......##O.....#
......O..#...O..O#O.#.O.......#.O#.....O.O#..#.#...O..##......O.O..O#.#.#..#.O.#O.O#.O.#......#.O...
....O.....O..O.......#.O.OO.....O##....##.#OO..#O..#.#...##..O#O.O...O..OO..##....O#O..O....#...O.#O
.......O.##O.#O#.........O#.OO....###.OO..O.#..#.....OO.O.O...O......O..O..O....O...#.#....#....#O..
O..#O......#.O..#O.O.#......O#..#.O##..#.#.O.....#.O...O..OO..####.#...##......#.....#O#......OO.O.#
...OOO.#O....O#O...O.##OO..#....OO...O.#.....OO.#OOO.#.........#....O....#.#..O.#O#.#...O.O...O.#...
..O.#.OOO..O.#...#OO.#.O.##OO..O..####.#....#.OO##O..#.O..O#..O#....#..O#..#.O.O..O...O...O.....O.O.
.#.#O.O..#.O.O##.....O#..#..#..OO##...OOO.#O...#.O#...#O....#OO.OO..#.OO#.OO#O#............O......#.
O#..#....O...#.#.O....#.OOO.#.OO.....OO###.O..#..#.O..#...#.#....O#.O#....#.#.O.#.....#....O.....O#.
O..O.#.....#.....OOO..O..OOO.#..#.##.O..O.......#..O.##O#...#.#.......#.#....#.O.O..OO..#.O..#..O#O.
...O...O#....#O.......#........#.O.O..O.#O#...O...#..O.#..OO#O...#........O...#.....OO.#...#.O...#.#
O.#.O#...O#....#OO.O.##......O...##..#..O#.#.#O.....OOO..#O....#...O..O#O....#.#....OO.#..#.....OO.#
...O#..O.#.#..O........O.....#.........#.....O.......O......#..#.#O....#O.O#O.#..##O#....#O...O.O...
#..O.O...O#..O.O.#O..#...O#....#..#...O..#O...O.....O..OO#OOO#OOO...#.O...#.OO#O.....#O.#.........O.
O.O...#....O#OO...O.OO..#..OO...#..O..O.O....#...#..O..OOO#.....#..OO.#O....O.#.O.OOO.#OO....##OO..O
.#O#.#.##...###O..O#...#.O.#.O...O#.O.....O....O..OOO....#...O...OO.....#.#O#O..#O......#.O.....#.#O
O.#O.OO......##......O..OOO##.OOO.#..O...O.O#..#O.#O.O......#................##..#....#O......#.....
........#.....##...OO.O......#..#.......#O.....O....O....#O.##..OO...O...O..........#..O.....OO...#.
#..O.#.......O......O#.O..........#O#.O#.#..#..O..O#.O.O..O.O........O......O..O.O..O.O..#O....O#.#.
...#...OO#..#..##.O.....O...........O.#O#O...##...O..#..#..O....#..O#O.##..O##......OOO....##..###.#
.#..#....OOO......O#O...##O..O.OO...O..#.....#.O..##.....#.#....O...#...OO#O#..O...OO#......#.#...O#
##..#....O...OOOO....OO...O......O.#.####O.O.....O..O..O...##O.#.O...#O..O....#O.O..O..O....O..#.O..
.......OO.O#.#O.O.O.O...O.OO...O.#..#...##..O..O.O...O..#..O#..##..O#.#.#.#.O#...O.....O#OO.........
...#.O#.O#..#....O.....OO..........#O.........O...O.#.....O........#..O...O...OO.##........#OO...O.O
#..O#.#..............#.#.#...O..O...#...OO.........#O..O#OOO..#....O....###.....O.O........##O...O.O
O.O#......O....#.#O..O..##O....#.....O###...#..#.#.........##........#O#..O#...O..#.#..O##OO.#.OOO..
#.#...##OO........O.....#...#..OO...OO..OO...O.#...O##....O..O#.O.O.O....#..O.##.......O#......O....
..#.O..#.......OO.....#...OO.O.O..O#.........#O.....#...#O......O.....O.........O..#..OO...O...O..OO
......O....O.O.....#.OOO.#..O.O.O.O.OO.#.O##OO...O....OO....O....O....#.O...........O......#...O...#
#O..##....#...OOOO......O.#.O#O...OO...O#..##O....O.....O..###.O#....O.........O...O#.....O..O.O...O
OO..#.#O....##.#..OOO...O#.......O.#...#.#....O.O#.#..#O#..#....#.O.##.OO.....#....#.....O#..#.....#
#.O.....#..#.O.....O#..#O#O.#.##O.....O.OO..O#.OO............O..O...O...##O..OO..O...#...O.....O#O.O
O........##.#O.OO...#...#O.#...O............##...O..#...OO.O.......#.O.O.....#.O........OOO#.##.....
....#...##.....O.....O.....#....#OO..O..#O.......O#.O..OO.#..OO......O..O..O...O..#O.......O..O..O#.
##.O.O....O.O#.........O.OOO..O.....O.OO..O....#.O...#.....#.#...O...OO#.OO..O.#..#.O.O.O...#..O.OO.
O..#..OO..O..#O...O...#..O#...........#.#......#..O#.O.#.....#O...O.......O.O.......O#O.#.#O..OO#.O#
..........O..O#......#.......#..O..O....O#.....O....O#...OO..O.O...#...O.O...O.O.O..##........#.#..#
.........O..#.O..#..#..#....O....O#..#.#..O....O....O....O...#O.......##.##.......O##.#..#..O...#O.#
##O...#..........O#.....O....#..O....#.O#O......OO.O.O........O...O.#..O#.......O....#......O.....#.
#.#.O.O...#.#....#.....O...O.#..OO#..#....#.O#.#O.#...O..O..OO...........#.....#..OO..#OOO#O...O...#
.#O...#....OO#....O.#....O##.#....#.O....O.#...O..O#.#.O..#..OO#.O....O.#.OO..#....OO.O...........O.
.O.#..#.O....O.....O.O#.#....O..##....O#.OO.....#..O...#O...OO..#....#...#..OO.O#..O...OO....#O...O.
.O..#O.....##...#....#.OOO...#.....O#.#O.O#OO.......#...O..#...#O.#...O....#.O..O#........#....O.#..
......#...O.O.....O..........#..##....O#O.#....#O..OO#..O........O...###.#.#..O.#O#OO#.##.OO...#O.O.
.#....OO.O...O.O##.##...OO.###..O#OO#.O..#O##.OO......#.OO#.#..OOO...O..O#OO...OO#O..O#....O.OO..OOO
...#O.....#OO.....O.O.#O.O..O......#O#O..O....O.O.OO.......#OO#..#..#..O...#.#O...O.O..O.......O..##
.#.O...O....O...#O.#O..O...#..O...#OOO#...O#...O.#O..##.#...##..#O.......O.#..#.O##....O.#..........
...O.#.....#..OO...O...O...O.O.#O...O.#.O..#.##.O.O......#...##.#O.#..##O.......#.O..#.OO.OO...#.OOO
......O..#.#O..OO.#..O#..O#...OO#......#.#.....##.#.#..#O##.O#O..#.#...#....O..#.O.#..O...OOOO.O#.O.
...OO..#.#..O.O..OO.O.O..O........#.O#O.#.O.O..O..O....O...#..O#.##..OO.......O.O.OO..O.O..O...#...O
.O......#....#.........#.....#.....#.....O.O.OO.O.#..O...OO#O....O##..O#O...#O.#........#OO..#..#OOO
....#..#..#.#O......OO.O.OO#....##.#..#...O..O......O.##.#.O#OO.#.............OO..#...#....OO..O#.#.
#....O#O#..OO..O.O#..........#O..O.#OO..#.O.#...O...#...O.#.#..#.#..O...#..#...###O..#....O#.#.#....
...O#.O.#...#...O..O.O.O.O........#O.O..O.#O....OO............O.....#.......O..O...O........O#O#.#O.
O.O..O.O....#..OO......#..O.......OO.....#.O.O..O...OOO..OOO#..O...#O.#O..OO....#.#O#O.O..#O....#...
.#..##.....##...O..O..#.....##...O.#O.O...#.....O.....O.#.#O..O..#......O...O.##...O###..O#.#...#.#.
.O.#....O...O..O#......#OOOO.O#....#O.......O...#..OO...O...O.#.............OOO..##..OO......O......
...#O.....O#..#....#...#O.O......#..O..#..O#O..#O..OO#..#.#...##....#O#...OO....O.OOO.#.O##O.O.#O.#.
..O...O.#O........##.#.O.OO....#...#...O.O.....O........O.....O#...O..#.O#.O.O.....#..O...#OO.#O.O.#
O........O...#......#.......O...#O#O#O....O..OO.#...#.......O......O#O....O.##..O#O.O#O.O.....##...#
..O#...O.#..O..O.##O.#...O.#..##.##....##....O.OOO.O......#..#...#..O###.#.#.O...##.O#OO#.O.#..O#.O#
#O........#.OO...O.##.....O.O...#O.#.#.#.O.O.#...OO...#.#.O.O..##..O#...O#.........#.....#..#.#..#.O
#....#.....#.#...O.#.O.OO..#........O.#..OO...O.O......O..#..#....OO....#..OO.#.#....#.......O.#O..O
...#..####...OO#....O.O..O.....#O.OO....O#O..###.OO..O...#O#.O##...O..........O.##.#.OO.O....O.....#
O.#..O.O.#.#.....O....O#.....##....#.......O.#.#O....O...#....O..O..O....O.O#..O.O....OO..OOO...OOO#
O..O.#.....O#.O##O...O....O#......#....O...O#....##O.#...#...O........OO#O........O...O...O....#...#
.O#.#...OO#...O...O.#O#.O..OO....#.O....OO.#.#.O##.O....O.............#..#..OOO.O.#O.O...O#....#..#O
#O#..#.#.OO......#..O....##.....O.#.O...OO.O...#.#.O..#.#O.O..O.......#.O...O......O..#.OOOOO..O.#..
#OOO...#.O..#....OOO#.O...........O...#OO#.......O..#.O...O.O.#.#...#..OO.##O....#...O....#.OO.O...#
.OO.#.O..##..#.O..O....#..##......O.O..O........#.....#O..O...OO..#..OO.....O.....#...#.....OO.....O
.#.O.O...O..O.....O.#.........O..O.......O...#....O..#..#.OO.O...O.#.#..O.O....OO.#.......O......O.O
.O.....O....#..O#....O#.OO#....#...#........O......OO.O.O...O..OO.O..#.O##.......O..#..O#.##..O#.OO.
OO.......#O....OO....#....#.O..#..#..OO.#.O..O#.O.O..##O#....O.O#.....OO.#OO....O...O....O#......O#.
..#O...O.O.#O...#......O..#...#...O...OO.O.#...#O.............O#OO.#...#.#O.#.#O#O.#O....OO..##.#.O.
#....O#OO...O##.O.O.OO......O....O....#O...O.......#..##......O.#.O....#OOO......O#O#.O.#..#..#.....
.....O.O......O..#.#O.#O#..O.OO.#O.O...#..##.......#O..#O..O.....O...O.......O.O#.#.O..#...O.O.#..O.
........O...O.....#.O....#O..##O##..#..O...#...O.O.O##.....O.....#...............#O...O..#O...O.#O.#
..O.O#...#.#O..#..#O...#......#OOOO.....OO.....##...OO..#.O##.OO....OO..#..#.#.#..O.#.O#.........#..
..O.##.##......#O.##...#......O.#...###.......#O.#.O.....#....#.......O...........OO.#O#...#.##.O#O.
#..#O.#O.....O......O.#.O#....#.###..O..#......O.O#..O#O.#O..O#O...O.#....O..O.OO.#OO.........O#.#..
INPUT

map = input.split("\n").map(&:chars)

def north(map)
  map.each_with_index do |row, y|
    next if y == 0
    row.each_with_index do |cell, x|
      next unless map[y][x] == "O"

      i = y
      while i > 0 && map[i-1][x] == "."
        i -= 1
      end

      map[y][x] = "."
      map[i][x] = "O"
    end
  end
end

def west(map)
  map.each_with_index do |row, y|
    row.each_with_index do |cell, x|
      next if x == 0
      next unless map[y][x] == "O"

      i = x
      while i > 0 && map[y][i-1] == "."
        i -= 1
      end

      map[y][x] = "."
      map[y][i] = "O"
    end
  end
end

def south(map)
  (map.size-1).downto(0).each do |y|
    next if y == map.size-1
    (map[y].size-1).downto(0).each do |x|
      next unless map[y][x] == "O"

      i = y
      while i < map[y].size - 1 && map[i+1][x] == "."
        i += 1
      end

      map[y][x] = "."
      map[i][x] = "O"
    end
  end
end

def east(map)
  (map.size-1).downto(0).each do |y|
    (map[y].size-1).downto(0).each do |x|
      next if x == map[y].size-1
      next unless map[y][x] == "O"

      i = x
      while i < map[y].size - 1 && map[y][i+1] == "."
        i += 1
      end

      map[y][x] = "."
      map[y][i] = "O"
    end
  end
end

##############
### PART 1 ###
##############

def count(map)
  map.reverse.map.with_index { |row, idx| (idx+1) * row.count("O") }.sum
end

north(map)

puts "Part 1: #{count(map)}"

##############
### PART 2 ###
##############

def tilt(map, excluding_north: false)
  north(map) unless excluding_north
  west(map)
  south(map)
  east(map)
end

tilt(map, excluding_north: true)

seen = {}
cycle_length = nil
first_repeat = nil

999_999_999.times do |i|
  if seen[map.flatten]
    first_repeat = seen[map.flatten]
    cycle_length = i - seen[map.flatten]
    break
  end

  seen[map.flatten] = i
  tilt(map)
end

((999_999_999 - first_repeat) % cycle_length).times do
  tilt(map)
end

puts "Part 2: #{count(map)}"
