input = <<~INPUT
....#..
..###.#
#...#.#
.#...##
#.###..
##.#.##
.#..#..
INPUT

input = <<~INPUT
..............
..............
.......#......
.....###.#....
...#...#.#....
....#...##....
...#.###......
...##.#.##....
....#..#......
..............
..............
..............
INPUT

input = <<~INPUT
######.##.#.###.#..##.#....#..###...#...##.#.#..##.#...#..##.#..#####.
.#.#....#.###.#....###......#..#.########.##.##..##...##.###.#.##.###.
#...###.##.#.##.#.##.#..##.#.....##.#.....#.#.#.#####.#####.#.#.....##
.###.#..##...#.#.#..#...###...#.#..###.#####..#.##....#.##.#..#...##.#
...####.#####.##..#.#...#.###..#######..###.#.#.#####.#.#..##........#
......##.##...##..#..########.....#######..#.####.#..##..##.#####..##.
##..#####..#.#..#.##..#..#..#..#####.####.#....#...##....##.###..#.#..
...#.#.####.##.###.#...#.##......###..#.####..##.#..#.#.##.#..#...###.
.#...#######.#.####.##..###....#.....#..###.#..#..#.#..####.#.#.######
......#.###.#####...........##.#..####..##.##.....###.######..##..#...
###...#.##....#.##...#.###....##.......#.#.##..#......###...###.####..
####.#.......####.####.#.########..#.#..#.#.###.######...##..##....##.
#.#.#..#...#.#...##.#####..###...........###..##..####..#.#.#######.##
###...#..#..#..#.####.###.#..####...#.#....#.....########...##...###.#
#.#...##.#.###..##..##.##....##..#.####.#.##.#.##..#.#.###.#.#.#.#.###
..#.######.##.#.#...##.###.##.#.####.##..#...#.#.##.####.#..###....#..
.##########...###....###.#.##..#.#.#..#.##..#.#...##..#.##.#..#..##.#.
..######.###..##.##.....#.#...#####.##..#.#.##....###.#.....#...#.#..#
.....###.#..##...##...#.#.#.#####....##.##.#.#....#...######.###.#....
#....#..###.#.##.##...###.#####.#....#....###.#..#.##..#.#...#.#######
##...#..###....#..#...#..###.#.##.#.##.#..###..##...##....##..##.#.#.#
#..####..#.###..#.#.#.##...#..####.#.....#..######......#########.#...
.##.###..#....###.##..#####.###.....##..#.........#......#.#..#.#.###.
##..######.###.###.#....#..##.#.#...#..##...##...##.##...#..##.#...###
.....#..#..##..#.##..#.#.#.#.##.#.#.#.###...##.#.#.#.#..#.#......####.
.#.#....#...#.##.####..#.###..#.###...#...#......###.####.###.##...#..
.#####.###.#.#..#.##..#.##..##..##....#.#.###....#.#....#..##...#.##.#
..##.##....#..#......###.###...###.#####.#...##..#####.###.##.##.#...#
##..###..#.###.###.####.##..#...##..##.#......#.##..##.#....#.#..#.#.#
##......#..#.#...#.#.##.....####...#.#...##.##....##.#.#.#.###.######.
#..##.....#.##..#.......#.#.#.##.#####..#..##.#....#....####..##.###.#
#.#.#.##.#..##.#..#.##..#........#..##.##.#..#..###.#.##..#.##.###.#..
..#.#.###...#....#.....#....#..##.#...##.##..##.##..#..#..#.#..##.####
####.#####.##.#..#...####.#..#.#...##...#..#..#.##...#.####..#####.##.
##..####..##.####.#####...###....####...##..##.#.....#.#..##.#...#..#.
#....##.###.######...#..#..##.#.#.#.#.#.#...#..#.###..#.#.##....##..##
.#.#.##.#.##...#...#.##.###.....#.#.#.#.#.#...#.#..##..#.####.#..#.###
####..##.#.#.....#.#..##.#####......#..#........######.###.######.#.##
.###.#.#..##...#.##...####.#......#..#.###..################.#.#..##.#
##.........#######...###.......#..##..#.#..#...##.#..#.###..#.###.##..
...#..#.##...######....#.#...#####...###.##.##..#..#.###.#...###.#...#
.#..#.##....#...###.###...###..###.##......#.##...#.#...##.######.#..#
##.#.##.###...#.##..#.###.....#.#..##.#.##..##...#.#######.#.######..#
##.#.###.##.#..#..##.##.##.....#.#.###...###..##....#......#.#.##..#..
#.#..#.##...#...##.##.#.#.##..##.##...#.######.##....#####.##.#.#.#...
...####....#.#.#.#.####.##.######.#####.##.###.##..###..#.###.#.#.####
#.#########...#.######.###....#.###..#....#.###.##..#...#..##...#..##.
#..####...#.#.##..#.#....##.#...###.#..##.#....#..##...#.##.##.###.##.
..##.....###......##.###...#.#..##.#.####.###.###.##....#####.###.#.#.
##.#....#.#..#.##.....#.###...#..###.####.###..#.##..#..#...#......#..
#...##..####.###...#...#...#.#.#.#.#...#.###...#.##..##.#.####...#....
#...#.#.##.##.#.##.##.##..#.#.#...#..#..####.#.####..#....##..#.#.##..
######.....#...#.##...#.###..######.#.###.#.....##...####...#.#.##..#.
####.#.##.#..###...##..###.##.##.#.####.###.##.##.##.###..##.###..#..#
.#.#...###..#.##.##...####...#....#..#.#.###..###.##.#...#..#..##..##.
.###.#.#..#.#..###..###....##.....##..#...###..##.#..#.#.#####.#....#.
.#....##...#.###.......#....#..#.#.##.###.#.#......#.##.#....###.#.#.#
######.#..######.#####...#.#.###..##..##...###.###.#.##....#...#.##..#
#.....##.#.####....###.###..##...##..#.#.##.#.#..#..###.###.###.##....
.#####..#.###.....##.##...##..#.##..##.#.##.##....#.##.#.########.####
.###..##.####..#.#..###.#...#######.###.#...##..##.....#..#.###.##...#
#.#...#.#####..#..#...##.##.#.##.###.###..#.##.#.#..#..####.##..####.#
.#..##.#..###...###.####.....#...#.#.##..##.#...###..####.#.##.##.#.##
.#.#...###......##.##..##.#.#..###..#.##....##..##..#.#...#.#####...#.
#.####.....#.#.#...#..#.#.#.###...#.#.#....#.....#.##.##.#.#.#..#..##.
#....####...###..####.#.....#######.#######.#....##.#######...#..###..
##....##..###...#.#.#.#..##....####.###.....##.##..#....##.#..#.#.##..
.......#..#.##...#.###..###..#..#..##.###.#...#..##....#.#..##.####.#.
..#.#..#.##..#..##...#....#...##.###.###...###....##....######..####.#
####.##....#.....##.#.#..####.#.###.#..####.#..##...#.#..#..#..##.###.
INPUT

def parse(input)
  elves = {}

  input.lines.each_with_index do |line, y|
    line.chars.each_with_index do |c, x|
      elves[[x, y]] = true if c == "#"
    end
  end

  elves
end

def all_neighbours_empty?(elves, x, y)
  [
    elves[[x - 1, y - 1]], elves[[    x, y - 1]], elves[[x + 1, y - 1]],
    elves[[x - 1,     y]],                        elves[[x + 1,     y]],
    elves[[x - 1, y + 1]], elves[[    x, y + 1]], elves[[x + 1, y + 1]],
  ].compact.empty?
end

def go_north?(elves, x, y)
  [
    elves[[x - 1, y - 1]],
    elves[[    x, y - 1]],
    elves[[x + 1, y - 1]],
  ].compact.empty?
end

def go_south?(elves, x, y)
  [
    elves[[x - 1, y + 1]],
    elves[[    x, y + 1]],
    elves[[x + 1, y + 1]],
  ].compact.empty?
end

def go_west?(elves, x, y)
  [
    elves[[x - 1, y - 1]],
    elves[[x - 1,     y]],
    elves[[x - 1, y + 1]],
  ].compact.empty?
end

def go_east?(elves, x, y)
  [
    elves[[x + 1, y - 1]],
    elves[[x + 1,     y]],
    elves[[x + 1, y + 1]],
  ].compact.empty?
end

def visualize(elves)
  return unless ENV["VISUALIZE"]
  print "\033c"
  minX = elves.keys.map(&:first).min
  maxX = elves.keys.map(&:first).max
  minY = elves.keys.map(&:last).min
  maxY = elves.keys.map(&:last).max

  minY.upto(maxY) do |y|
    minX.upto(maxX) do |x|
      color = if elves[[x, y]]
        "0;221;0"
      else
        "255;255;255"
      end

      print "\e[38;2;#{color}m"
      print "\e[48;2;#{color}mX"
      print "\033[0m"
    end
    puts
  end
end

def count_map(elves)
  minX = elves.keys.map(&:first).min
  maxX = elves.keys.map(&:first).max
  minY = elves.keys.map(&:last).min
  maxY = elves.keys.map(&:last).max

  (maxX - minX + 1) * (maxY - minY + 1) - elves.count { |_, v| v }
end

def solve(elves, part)
  visualize(elves) if part == 2

  directions = [
    [:north, 0, -1],
    [:south, 0,  1],
    [:west, -1,  0],
    [:east,  1,  0],
  ]

  i = 0
  loop do
    return count_map(elves) if part == 1 && i == 10
    i += 1
    proposed_moves = {}

    elves.each do |(x, y), _|
      next if all_neighbours_empty?(elves, x, y)

      directions.each do |(direction, dx, dy)|
        if send("go_#{direction}?", elves, x, y)
          proposed_moves[[x, y]] = [x + dx, y + dy]
          break
        end
      end
    end

    proposed_moves = proposed_moves.reject { |_, v| proposed_moves.values.count(v) > 1 }

    return "No more moves possible\nRound #{i}" if proposed_moves.empty?

    proposed_moves.each do |(x, y), (nx, ny)|
      elves.delete([x, y])
      elves[[nx, ny]] = true
    end

    visualize(elves) if part == 2

    directions.rotate!
  end
end

puts "PART 1"
t = Time.now
elves = parse(input)
puts solve(elves, 1)
puts "Took #{Time.now - t} seconds"

puts
puts "PART 2"
t = Time.now
elves = parse(input)
puts solve(elves, 2)
puts "Took #{Time.now - t} seconds"
